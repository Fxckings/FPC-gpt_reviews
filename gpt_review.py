from __future__ import annotations

from typing import Final
from enum import Enum
from FunPayAPI.updater.events import NewMessageEvent
from FunPayAPI.types import MessageTypes
from FunPayAPI.common.utils import RegularExpressions
from cardinal import Cardinal
from pip._internal.cli.main import main
import random
import re
import logging

try:
    from g4f.client import Client
except ImportError:
    main(["install", "-U", "g4f"])
    from g4f.client import Client
client = Client()

logger = logging.getLogger("FPC.ChatGPT-Reviews")
LOGGER_PREFIX = "[ChatGPT-Review's]"
logger.info(f"{LOGGER_PREFIX} –ü–ª–∞–≥–∏–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.")

NAME = "ChatGPT Reviews"
VERSION = "0.0.14"
DESCRIPTION = "–û—Ç–∑—ã–≤—ã –æ—Ç AI (g4f)"
CREDITS = "@fasxw | @tinkovof"
UUID = "cc8fe1ee-6caf-4eb0-922a-6636e17c3cf9"
SETTINGS_PAGE = False

MAX_WORDS: Final[int] = 300
MAX_CHARACTERS: Final[int] = 1000
SEND_IN_CHAT: Final[bool] = True

SETTINGS = {
    "prompt": """
        –ü—Ä–∏–≤–µ—Ç! –¢—ã - –ò–ò –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –Ω–∞—à–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–µ –∏–≥—Ä–æ–≤—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π. 
        –î–∞–≤–∞–π –ø–æ—Å–º–æ—Ç—Ä–∏–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ –∏ —Å–æ—Å—Ç–∞–≤–∏–º –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è! üòä

        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ –∏ –∑–∞–∫–∞–∑–µ:

        - –ò–º—è: {name}
        - –¢–æ–≤–∞—Ä: {item}
        - –°—Ç–æ–∏–º–æ—Å—Ç—å: {cost} —Ä—É–±–ª–µ–π
        - –û—Ü–µ–Ω–∫–∞: {rating} –∏–∑ 5
        - –û—Ç–∑—ã–≤: {text}

        –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
        - –û—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –≤ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–º —Ç–æ–Ω–µ. üôè 
        - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—Å–µ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ üòÑ).
        - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á–µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ –∏ –∑–∞–∫–∞–∑–µ.
        - –°–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –æ—Å—Ç–∞–ª—Å—è –¥–æ–≤–æ–ª–µ–Ω. üòå
        - –ù–∞–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–æ–π –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç. 
        - –ü–æ–∂–µ–ª–∞—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å —Ö–æ—Ä–æ—à–µ–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é. ‚ú®
        - –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤–∏—Ç—å —à—É—Ç–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º –∏–ª–∏ –µ–≥–æ –∑–∞–∫–∞–∑–æ–º. üòÇ
        –í–∞–∂–Ω–æ:
        - –ù–µ —É–ø–æ–º–∏–Ω–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ—Å—É—Ä—Å—ã. 
        - –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, –Ω–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é –ª–µ–∫—Å–∏–∫—É, –ø—Ä–æ—Ç–∏–≤–æ–∑–∞–∫–æ–Ω–Ω—É—é –∏–ª–∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. 
    """,
}

MIN_STARS: Final[int] = 3
ANSWER_ONLY_ON_NEW_FEEDBACK: Final[bool] = True
SEND_IN_CHAT: Final[bool] = True
MAX_ATTEMPTS: Final[int] = 5
MINIMUM_RESPONSE_LENGTH: Final[int] = 15
CHINESE_PATTERN = re.compile(r'[\u4e00-\u9fff]')

class G4FModels(Enum):
    GPT4_MINI = "gpt-4o"
    LLAMA3_1 = "llama-3.1-70b"
    SONNET = "claude-3.5-sonnet"

def log(text: str) -> None:
    logger.info(f"{LOGGER_PREFIX} {text}")

def tg_log(cardinal: Cardinal, text: str) -> None:
    for user in cardinal.telegram.authorized_users:
        bot = cardinal.telegram.bot
        bot.send_message(user, text, parse_mode="HTML")

def replace_items(prompt: str, order) -> str:
    replacements = {
        "{category}": getattr(order.subcategory, "name", ""),
        "{categoryfull}": getattr(order.subcategory, "fullname", ""),
        "{cost}": str(order.sum),
        "{disc}": str(getattr(order, "description", "N/A")), 
        "{rating}": str(getattr(order.review, "stars", "")),
        "{name}": str(getattr(order, "buyer_username", "")),
        "{item}": str(getattr(order, "title", "")),
        "{text}": str(getattr(order.review, "text", ""))
    }

    try:
        for placeholder, replacement in replacements.items():
            prompt = prompt.replace(placeholder, replacement)
    except Exception as e:
        logger.error(f"An unexpected error occurred: {e}")
    finally:
        logger.debug(f"Processed prompt: {prompt}")
        return prompt


def need_regenerate(content: str) -> bool:
    try:
        if re.search(CHINESE_PATTERN, content):
            return True

        content = content.replace("Generated by BLACKBOX.AI, try unlimited chat https://www.blackbox.ai", "")
        if len(content) < MINIMUM_RESPONSE_LENGTH:
            return True

        if (
            "Unable to decode JSON response‚Å°" in content or
            "Model not found or too long input. Or any other error (xD)" in content or
            "Request ended with status code" in content
        ):
            return True

        return False

    except Exception:
        return False

def generate(prompt: str) -> str:
    try:
        response = g4f_generate_response(prompt)

        if not response:
            return ""
        return response

    except Exception as e:
        logger.error(f"Error generating response: {e}")
        return ""

def g4f_generate_response(prompt: str) -> str:
    models = list(G4FModels)
    for attempt in range(MAX_ATTEMPTS):
        model = random.choice(models)
        try:
            response = client.chat.completions.create(
                model=model.value,
                messages=[
                    {"role": "user", "content": prompt}
                ]
            )
            content = response.choices[0].message.content

            if need_regenerate(content):
                continue

            return content

        except Exception as e:
            logger.error(f"Error in attempt {attempt + 1}: {e}")

    return ""

def truncate_text(text: str, max_chars: int) -> str:
    if len(text) <= max_chars:
        return text
    return text[:max_chars].rstrip() + '...'

def message_handler(cardinal: Cardinal, event: NewMessageEvent) -> None:
    try:
        if ANSWER_ONLY_ON_NEW_FEEDBACK and event.message.type != MessageTypes.NEW_FEEDBACK:
            return
        if event.message.type not in [MessageTypes.NEW_FEEDBACK, MessageTypes.FEEDBACK_CHANGED]:
            return
        order_id = RegularExpressions().ORDER_ID.findall(str(event.message))[0][1:]
        order = cardinal.account.get_order(order_id)
        if order.review.stars <= MIN_STARS:
            return

        prompt: str = replace_items(SETTINGS["prompt"], order)
        response: str = generate(prompt)
        response = " ".join(response.splitlines())

        words = response.split()
        if len(words) > MAX_WORDS:
            response = ' '.join(words[:MAX_WORDS]) + '...'
            logger.debug(f"Response truncated to {MAX_WORDS} words.")

        response_details = f"(„Å• ‚óï‚Äø‚óï )„Å• üõç [{order.title or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}]\n\n{response}"
        response_details = truncate_text(response_details, 700)  

        logger.debug(f"Final response_details: {response_details}")
        logger.debug(f"Final length: {len(response_details)} characters.")

        if len(response_details) > 700:
            logger.warning("Final response_details still exceed the character limit.")
            response_details = truncate_text(response_details, 700)

        cardinal.account.send_review(order_id=order.id, rating=None, text=response_details)

        if SEND_IN_CHAT:
            response2chat = generate(f"""
                                –ü—Ä–∏–≤–µ—Ç, —É –Ω–∞—Å (–º—ã –ø—Ä–æ–¥–∞–≤–µ—Ü –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ funpay.com, —Å –Ω–∏–∫–æ–º {cardinal.account.username}) –æ–ø–ª–∞—Ç–∏–ª –ø–æ–∫—É–ø–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {order.buyer_username}: {order.title}.
                                –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –µ–≥–æ, –ø—Ä–∏–¥—É–º–∞–π —à—É—Ç–∫—É, –ø–æ–¥–±–æ–¥—Ä–∏ –µ–≥–æ, –ø–æ–∂–∞–ª–∞–π —á—Ç–æ –±—ã –µ—â–µ —É –Ω–∞—Å –ø–æ–∫—É–ø–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è.""")
            if response2chat:
                cardinal.send_message(event.message.chat_id, response2chat)

    except Exception as e:
        logger.error(f"An unexpected error occurred: {e}")

BIND_TO_NEW_MESSAGE = [message_handler]
BIND_TO_DELETE = None
